### CAS

https://habr.com/ru/post/470317/

*Compare And Swap. Сравнение с обменом.* Это атомарная инструкция с тремя аргументами: атомарная переменная или адрес в памяти, ожидаемое значение, новое значение. Если и только если значение переменной совпадает с ожидаемым, переменная получает новое значение и инструкция завершается успешно. CAS либо просто возвращает булево значение (и тогда ее можно называть Compare And Set), либо в случае неудачи возвращает еще и текущее значение первого аргумента.

Псевдокод

```c++
bool cas(int* addr, int& expected, int new_value)
{
    if (*addr != expected)
    {
        expected = *addr;
        return false;
    }
    *addr = new_value;
    return true;
}
```

В C++ CAS представлена семействами методов `std::atomic<T>::compare_exchange_weak`, `std::atomic<T>::compare_exchange_strong` и свободных функций `std::atomic_compare_exchange_weak`, `std::atomic_compare_exchange_strong`. Разница между `*weak` и `*strong` в том, что первые могут выдавать ложно-отрицательные результаты. Т.е. если значение равно ожидаемому, они вернут `false` и не заменят его на новое. Причина существования `*weak` операций в том, что на некоторых архитектурах `*strong` относительно дороги. В большинстве случаев CAS инструкции крутятся в цикле (т. н. `CAS loop`), поэтому использование `*weak` вместо `*strong` не изменит логику, но может повысить производительность.

CAS инструкции используются для реализации примитивов синхронизации (таких, как мьютексы и семафоры) и свободных от блокировок алгоритмов. Часто приводят к проблеме ABA.



